<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flock behavior & herding dogs</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Lato:wght@300;400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --poster-blue: #1E4A39;
        --poster-light-blue: #2d7a5a;
        --grass-color: #dceebb;
      }

      body {
        background-color: #2d3748;
        font-family: "Lato", sans-serif;
        overflow: hidden;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        width: 100vw;
      }

      #poster-frame {
        aspect-ratio: 16 / 9;
        width: 95vw;
        max-height: 95vh;
        background: white;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        display: grid;
        grid-template-rows: auto 1fr auto;
        position: relative;
        overflow: hidden;
      }

      h1, h2, h3 { font-family: "Merriweather", serif; }

      /* Simulation Area */
      #simulation-container {
        position: relative;
        width: 100%;
        height: 100%;
        background: var(--grass-color);
        cursor: default;
      }

      /* Video Containers */
      .video-wrapper {
        display: none;
        width: 100%;
        height: 100%;
        background: black;
      }

      /* HUD Element for Controls */
      .controls-hud {
        position: absolute;
        bottom: 10px;
        left: 10px;
        width: 250px;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 8px;
        font-size: 0.75rem;
        pointer-events: auto;
        z-index: 30;
        border: 1px solid #cbd5e1;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.5s ease-in-out, opacity 0.5s;
      }

      .controls-hud.hidden-hud {
        transform: translateX(-300px);
        opacity: 0;
      }

      .hud-section-header {
        padding: 10px 12px;
        background: rgba(240, 245, 243, 0.5);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e2e8f0;
        user-select: none;
      }
      
      .hud-content {
        padding: 12px;
        transition: max-height 0.3s ease-out;
        max-height: 500px;
        overflow: hidden;
      }
      
      .hud-content.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        border: none;
      }

      .chevron-icon { transition: transform 0.2s; }
      .collapsed-icon { transform: rotate(-90deg); }

      input[type="range"] {
        width: 100%;
        accent-color: var(--poster-light-blue);
        cursor: pointer;
      }

      /* Checkbox Styling */
      .checkbox-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        font-weight: bold;
        color: #1E4A39;
        cursor: pointer;
        background: #f0fdf4;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #bbf7d0;
      }
      .checkbox-wrapper input {
        accent-color: var(--poster-blue);
        width: 16px;
        height: 16px;
      }
      
      .radio-group label {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
        cursor: pointer;
      }
      .radio-group input[type="radio"] { accent-color: var(--poster-blue); }

      .switch-btn {
        transition: all 0.2s;
        border: 2px solid transparent;
      }
      .switch-btn.active {
        background-color: var(--poster-light-blue);
        color: white;
        border-color: var(--poster-blue);
      }
      
      #timer-display {
        font-family: 'Courier New', monospace;
        font-size: 1.2rem;
      }

      /* Instructions Overlay */
      #instructions-overlay {
        position: absolute;
        top: 20px;
        left: 280px;
        width: 300px;
        background: rgba(30, 74, 57, 0.9);
        color: white;
        padding: 20px;
        border-radius: 8px;
        z-index: 25;
        backdrop-filter: blur(4px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: opacity 0.3s;
        pointer-events: none;
      }

      #countdown-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: 'Merriweather', serif;
        font-size: 8rem;
        font-weight: 900;
        color: #1E4A39;
        text-shadow: 0 4px 10px rgba(0,0,0,0.2);
        z-index: 40;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .section-box {
        background: rgba(255, 255, 255, 0.92);
        padding: 1rem;
        border-left: 5px solid var(--poster-light-blue);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: background 0.2s;
      }
      .card-header {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .card-content {
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        max-height: 500px;
      }
      .collapsed .card-content { max-height: 0; }
      .chevron { transition: transform 0.3s; }
      .collapsed .chevron { transform: rotate(-90deg); }

      /* Stats Button & Modal */
      #stats-btn {
        transition: all 0.2s;
        display: none; /* Hidden by default */
      }
      #stats-btn:hover {
        transform: scale(1.05);
      }
      #stats-modal {
        animation: fadeIn 0.2s ease-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
    </style>

<script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
    }
  }
</script>
  </head>
  <body>
    <div id="poster-frame">
      <header
        class="bg-[#1E4A39] text-white p-6 grid grid-cols-12 gap-4 items-center border-b-8 border-[#1E4A39]"
      >
        <div class="col-span-9">
          <h1 class="text-4xl font-bold tracking-tight">
            Flock dynamics in herding applications
          </h1>
          <p class="text-xl text-green-200 font-light mt-1">
            An interactive simulation of a shepherd dog herding sheep
          </p>
        </div>
        <div class="col-span-3 text-right border-l border-slate-700 pl-4">
          <p class="font-bold text-lg">University of Salzburg</p>
          <p class="text-sm opacity-80 italic">
            Faculty of Digital and Analytical Sciences
          </p>
        </div>
      </header>

      <main class="grid grid-cols-12 gap-6 p-6 overflow-hidden">
        <aside class="col-span-2 flex flex-col gap-4">
          <div class="bg-slate-100 p-4 rounded-lg border border-slate-300">
            <h3
              class="text-[10px] font-bold uppercase tracking-widest text-slate-500 mb-4"
            >
              View Selection
            </h3>
            
            <button
            id="btn-sim"
            class="active switch-btn w-full py-3 px-2 rounded text-sm font-bold bg-white text-slate-600 border-slate-200 shadow-sm"
            >
            Interactive Game
            </button>
            
            <button
            id="btn-res"
            class="switch-btn w-full py-3 px-2 rounded text-sm font-bold bg-white text-slate-600 border-slate-200 shadow-sm"
            >
            Real-World Case Study
            </button>

            <button
            id="btn-game-vid"
            class="switch-btn w-full py-3 px-2 rounded text-sm font-bold bg-white text-slate-600 border-slate-200 shadow-sm"
            >
            GAMA Simulation
            </button>
          </div>
        </aside>

        <div
          class="col-span-7 flex flex-col rounded-lg shadow-inner overflow-hidden border-2 border-slate-200"
        >
          <div id="simulation-container">
            
            <div id="instructions-overlay">
              <h3 class="font-bold text-lg mb-2 border-b border-green-700 pb-1">How to Simulate</h3>
              <ul class="list-disc pl-4 text-xs space-y-2">
                <li>Configure the <strong>Breed</strong> and <strong>Count</strong>.</li>
                <li><strong>Fence:</strong> Enable to keep sheep inside the screen.</li>
                <li>Click <strong>START</strong> to begin.</li>
                <li>Use your <strong>Mouse</strong> to control the dog.</li>
                <li>Herd sheep into the <strong>Brown Pen</strong>.</li>
              </ul>
            </div>

            <div id="countdown-overlay">3</div>

            <div
              class="absolute top-4 right-4 bg-white/90 border-2 border-[#1E4A39] px-4 py-2 rounded shadow-lg z-20 font-bold text-[#1E4A39] pointer-events-none text-right"
            >
              <div class="text-xs text-slate-500 uppercase tracking-widest mb-1">Status</div>
              <div>PENNED: <span id="score" class="text-green-600">0</span></div>
              <div>LOST: <span id="lost" class="text-red-600">0</span></div>
              <div class="border-t border-slate-300 mt-1 pt-1 text-slate-400 text-[10px]">TOTAL: <span id="total">30</span></div>
              <div id="timer-display" class="text-slate-800 mt-1">00:00.0</div>
            </div>

            <div id="controls-box" class="controls-hud">
              <div class="p-3 bg-white border-b border-slate-100">
                 <div class="mb-2">
                  <label class="flex justify-between font-bold text-[#1E4A39]"
                    >Sheep Count <span id="val-count">30</span></label
                  >
                  <input
                    type="range"
                    id="param-count"
                    min="10"
                    max="100"
                    step="1"
                    value="30"
                  />
                </div>
                <label class="checkbox-wrapper hover:bg-green-50 transition">
                    <input type="checkbox" id="param-fence">
                    <span>Enable Outer Fence</span>
                </label>
              </div>

              <div class="hud-section-header" onclick="toggleHudParams()">
                <p class="font-bold text-[#1E4A39] uppercase tracking-wide text-[10px]">Boids Parameters</p>
                <span id="hud-chevron" class="chevron-icon">â–¼</span>
              </div>

              <div id="hud-params-content" class="hud-content">
                <div class="mb-4 border-b border-slate-300 pb-2">
                  <div class="radio-group text-slate-700">
                    <label>
                      <input type="radio" name="breed" value="merino" checked>
                      Merino (Tight)
                    </label>
                    <label>
                      <input type="radio" name="breed" value="scottish">
                      Scottish Blackface (Loose)
                    </label>
                    <label>
                      <input type="radio" name="breed" value="custom">
                      Custom
                    </label>
                  </div>
                </div>

                <div class="mb-2">
                  <label class="flex justify-between font-bold"
                    >Separation <span id="val-sep">0.0002</span></label
                  >
                  <input
                    type="range"
                    id="param-sep"
                    min="0"
                    max="0.010"
                    step="0.001"
                    value="0.001"
                  />
                </div>
                <div class="mb-2">
                  <label class="flex justify-between font-bold"
                    >Alignment <span id="val-ali">0.005</span></label
                  >
                  <input
                    type="range"
                    id="param-ali"
                    min="0"
                    max="0.02"
                    step="0.001"
                    value="0.008"
                  />
                </div>
                <div class="mb-2">
                  <label class="flex justify-between font-bold"
                    >Cohesion <span id="val-coh">0.007</span></label
                  >
                  <input
                    type="range"
                    id="param-coh"
                    min="0"
                    max="0.02"
                    step="0.001"
                    value="0.012"
                  />
                </div>
              </div>

              <div class="p-2 border-t border-slate-100 bg-slate-50 flex gap-2">
                 <button
                  id="reset-sim"
                  class="flex-1 bg-slate-300 text-slate-700 text-[10px] py-2 rounded hover:bg-slate-400 transition uppercase tracking-widest font-bold"
                >
                  Reset
                </button>
                 <button
                  id="start-sim"
                  class="flex-1 bg-[#1E4A39] text-white text-[10px] py-2 rounded hover:bg-[#2d7a5a] transition uppercase tracking-widest font-bold shadow-md"
                >
                  Start
                </button>
              </div>
            </div>

            <div id="stats-btn" class="absolute bottom-4 right-4 bg-white/90 border border-slate-300 p-2 rounded cursor-pointer hover:bg-white transition shadow-lg z-30 flex items-center gap-2 group pointer-events-auto">
                <span class="text-xl">ðŸ“Š</span>
                <span class="text-xs font-bold text-slate-700 uppercase tracking-widest group-hover:text-[#1E4A39]">Stats</span>
            </div>

            <div id="stats-modal" class="absolute inset-0 z-50 bg-black/40 hidden flex items-center justify-center backdrop-blur-sm pointer-events-auto">
                <div class="bg-white p-6 rounded-lg shadow-2xl w-[500px] max-w-[90%] relative">
                    <button id="close-stats" class="absolute top-2 right-2 text-slate-400 hover:text-slate-600 text-xl font-bold">&times;</button>
                    <h3 class="font-bold text-lg text-[#1E4A39] mb-4 border-b pb-2">Herding Performance History</h3>
                    <div class="w-full">
                         <canvas id="herdingChart"></canvas>
                    </div>
                    <div class="flex justify-between text-[10px] mt-4 px-2 text-slate-500">
                      <span class="text-[#1E4A39] font-bold">â–  Time (s)</span>
                      <span class="text-[#2d7a5a] font-bold">â–  Success (%)</span>
                  </div>
                </div>
            </div>

          </div>

          <div id="game-video-container" class="video-wrapper relative">
            <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-20 bg-white/90 rounded-full p-1 shadow-lg border border-slate-200 flex gap-1 backdrop-blur-sm">
              <button 
                id="btn-vid-merino" 
                class="px-4 py-1.5 rounded-full text-[10px] uppercase tracking-wider font-bold bg-[#1E4A39] text-white shadow-sm transition-all"
              >
                Merino
              </button>
              <button 
                id="btn-vid-scottish" 
                class="px-4 py-1.5 rounded-full text-[10px] uppercase tracking-wider font-bold text-slate-600 hover:bg-slate-100 transition-all"
              >
                Black Headed
              </button>
            </div>

            <video
              id="video-merino"
              class="w-full h-full object-cover"
              controls
              loop
              muted
            >
              <source src="merino.mp4" type="video/mp4" />
            </video>

            <video
              id="video-scottish"
              class="w-full h-full object-cover"
              controls
              loop
              muted
            >
              <source src="blackheadedsheep.mp4" type="video/mp4" />
            </video>
          </div>

          <div id="video-container" class="video-wrapper">
            <video
              id="resVideo"
              class="w-full h-full object-cover"
              controls
              loop
              muted
            >
              <source src="research_results.mp4" type="video/mp4" />
            </video>
          </div>
        </div>

        <aside class="col-span-3 flex flex-col gap-4 overflow-y-auto">
          <div id="sidebar-real" class="hidden flex-col gap-4">
            <div class="section-box collapsed" id="card-field">
              <div class="card-header border-b mb-2" onclick="toggleCard('card-field')">
                <h2 class="text-xl font-bold text-slate-800">About This Footage</h2>
                <span class="chevron">â–¼</span>
              </div>
              <div class="card-content">
                
                <p class="text-xs leading-relaxed mb-4">
                  Aerial drone footage capturing a working shepherd dog herding approximately <strong>800 sheep</strong> through a gate into a target pasture. This real-world observation demonstrates:
                </p>
                <ul class="text-xs space-y-2 list-disc list-inside ml-2 mb-4">
                  <li><strong>Natural flocking behavior</strong> under predator pressure</li>
                  <li><strong>Strategic dog positioning</strong> using orbiting and weaving techniques</li>
                  <li><strong>Herding dynamics</strong> as the flock compresses toward the gate</li>
                </ul>
                <p class="text-xs leading-relaxed mb-2">
                  This real-world scenario served as the reference for calibrating our simulation parameters and validating model behavior. 
                </p>
              </div>
            </div>

            <div class="section-box collapsed" id="card-compare">
              <div class="card-header border-b mb-2" onclick="toggleCard('card-compare')">
                <h2 class="text-xl font-bold text-slate-800">What We Measured</h2>
                <span class="chevron">â–¼</span>
              </div>
              <div class="card-content">
                <p class="text-xs leading-relaxed mb-3">
                  Frame-by-frame analysis extracts the flock's <strong>convex hull</strong>â€”the smallest polygon encompassing all sheep positions. Three key metrics quantify herding dynamics:
                </p>
                <ul class="text-xs space-y-2 list-disc list-inside ml-2">
                  <li><strong>Hull Area (pixelsÂ²):</strong> Measures flock spread and compression under dog pressure</li>
                  <li><strong>Hull Complexity:</strong> Number of vertices (boundary sheep) indicating flock cohesion</li>
                  <li><strong>Centroid-to-Gate Distance:</strong> Tracks progress toward the target entrance</li>
                </ul>
                <p class="text-xs leading-relaxed mt-3">
                  These geometric abstractions translate complex animal behavior into quantifiable trajectories.
                </p>
              </div>
            </div>

            <div class="section-box collapsed" id="card-techniques">
              <div class="card-header border-b mb-2" onclick="toggleCard('card-techniques')">
                <h2 class="text-xl font-bold text-slate-800">Observed Patterns</h2>
                <span class="chevron">â–¼</span>
              </div>
              <div class="card-content">
                <p class="text-xs leading-relaxed mb-3">
                  Analysis of the drone footage reveals consistent behavioral patterns:
                </p>
                <ul class="text-xs space-y-2 list-disc list-inside ml-2 mb-3">
                  <li><strong>Decreasing hull area:</strong> Flock compresses steadily as the dog maintains pressure</li>
                  <li><strong>Reducing complexity:</strong> Boundary sheep decrease as stragglers join the core group</li>
                  <li><strong>Smooth centroid trajectory:</strong> The flock center moves progressively toward the gate</li>
                </ul>
              </div>
            </div>

            <div class="section-box collapsed" id="card-valid">
              <div class="card-header border-b mb-2" onclick="toggleCard('card-valid')">
                <h2 class="text-xl font-bold text-slate-800">Limitations</h2>
                <span class="chevron">â–¼</span>
              </div>
              <div class="card-content">
                <p class="text-xs leading-relaxed mb-3">
                  This footage captures one specific herding scenario. Real-world variation includes:
                </p>
                <ul class="text-xs space-y-2 list-disc list-inside ml-2 mb-3">
                  <li><strong>Environmental factors:</strong> Terrain elevation, weather conditions, pasture layout</li>
                  <li><strong>Animal characteristics:</strong> Sheep breed temperament, flock size, exhaustion levels</li>
                  <li><strong>Dog expertise:</strong> Training level, breed-specific techniques, experience with this flock</li>
                </ul>
                <p class="text-xs leading-relaxed">
                  Working shepherd dogs rely on <strong>visual perception with occlusion</strong>, depth estimation, and learned instinctâ€”factors invisible to aerial observation.
                </p>
              </div>
            </div>
          </div>


            <div id="sidebar-game" class="flex flex-col gap-4">
            <div class="section-box collapsed" id="card-howto">
              <div class="card-header border-b mb-2" onclick="toggleCard('card-howto')">
                <h2 class="text-xl font-bold text-slate-800">How to Play?</h2>
                <span class="chevron">â–¼</span>
              </div>
              <div class="card-content">
                <p class="text-xs leading-relaxed mb-3">
                  Control the dog with your mouse to herd sheep into the brown pen:
                </p>
                <ol class="text-xs space-y-2 list-decimal list-inside ml-2 mb-3">
                <li><strong>Select a breed</strong> (or customize parameters)</li>
                <li><strong>Adjust sheep count</strong> using the slider</li>
                <li><strong>Click START</strong> and begin herding</li>
                </ol>
                <p class="text-xs leading-relaxed">
                    Watch how different breeds respond to pressureâ€”tight flocks move as one unit, loose flocks scatter and regroup dynamically.
                </p>
              </div>
            </div>
            
            <div class="section-box collapsed" id="card-flocking">
              <div class="card-header border-b mb-2" onclick="toggleCard('card-flocking')">
                <h2 class="text-xl font-bold text-slate-800">What is Flocking?</h2>
                <span class="chevron">â–¼</span>
              </div>
              <div class="card-content">
                <p class="text-xs leading-relaxed mb-3">
                                  Flocking is <strong>emergent behavior</strong>â€”no sheep "knows" the group pattern, but simple individual rules create complex collective motion.
                </p>
                <p class="text-xs leading-relaxed mb-2">
                                  <strong>Each sheep follows three rules:</strong>
                </p>
                <ul class="text-xs space-y-2 list-disc list-inside ml-2">
                <li><strong>Separation:</strong> Avoid collisions with nearby neighbors</li>
                <li><strong>Alignment:</strong> Match the speed and direction of neighbors</li>
                <li><strong>Cohesion:</strong> Stay close to the group center</li>
                </ul>
                <p class="text-xs leading-relaxed mt-3">
                    That's it! These three simple rules generate all the complex patterns you see.
                </p>
              </div>
            </div>
            
            <div class="section-box collapsed" id="card-behavior">
              <div class="card-header border-b mb-2" onclick="toggleCard('card-behavior')">
                <h2 class="text-xl font-bold text-slate-800">Sheep Behavior</h2>
                <span class="chevron">â–¼</span>
              </div>
              <div class="card-content">
                <p class="text-xs leading-relaxed mb-2">
                  <strong>Merino:</strong> Tight flocking (high cohesion). Move as a dense ball, easier to guide but harder to split.<br><br>
                  <strong>Scottish Blackface:</strong> Loose flocking (low cohesion). Spread widely, more independent, require broader dog movements.<br><br>
                  <strong>Custom:</strong> Adjust parameters yourself to explore different behaviors!
                </p>
              </div>
            </div>
            
            <div class="section-box collapsed" id="card-parameters">
              <div class="card-header border-b mb-2" onclick="toggleCard('card-parameters')">
                <h2 class="text-xl font-bold text-slate-800">Parameters</h2>
                <span class="chevron">â–¼</span>
              </div>
              <div class="card-content">
                <p class="text-xs leading-relaxed mb-2">
                  <strong>Separation:</strong> How much sheep avoid crowding neighbors. Higher values = more personal space.<br><br>
                  <strong>Alignment:</strong> How much sheep match their neighbors' direction and speed. Higher values = synchronized movement.<br><br>
                  <strong>Cohesion:</strong> How strongly sheep are attracted to the group center. Higher values = tighter flocks.
                </p>
              </div>
            </div>
            
            <div class="section-box collapsed" id="card-protip">
              <div class="card-header border-b mb-2" onclick="toggleCard('card-protip')">
                <h2 class="text-xl font-bold text-slate-800">Pro Tip</h2>
                <span class="chevron">â–¼</span>
              </div>
              <div class="card-content">
                <p class="text-xs leading-relaxed">
                  Weave side-to-side to apply gentle pressure. Position behind the flock's center to funnel them forward. Move too fast and they panic-scatter. Too slow and they ignore you. Find the sweet spot!
                </p>
              </div>
            </div>
          </div>
          
          <div id="sidebar-imrad" class="hidden flex-col gap-4">
            <div class="section-box collapsed" id="card-intro">
              <div class="card-header border-b mb-2" onclick="toggleCard('card-intro')">
                <h2 class="text-xl font-bold text-slate-800">Introduction</h2>
                <span class="chevron">â–¼</span>
              </div>
              <div class="card-content">
                <p class="text-xs leading-relaxed mb-2">
                  Effective herding requires understanding how species-specific behaviors influence flock dynamics. This study uses Agent-Based Modeling (ABM) in the <strong>GAMA Platform</strong> to simulate shepherding.
                </p>
                <p class="text-xs leading-relaxed">
                  <strong>Objective:</strong> To quantify the impact of "tight" vs. "loose" flocking behaviors on the time required to pen a group of 30 sheep.
                </p>
              </div>
            </div>

            <div class="section-box collapsed" id="card-methods">
              <div class="card-header border-b mb-2" onclick="toggleCard('card-methods')">
                <h2 class="text-xl font-bold text-slate-800">Methods</h2>
                <span class="chevron">â–¼</span>
              </div>
              <div class="card-content">
                <p class="text-xs leading-relaxed mb-2">
                  <strong>Setup:</strong> A continuous 2D environment with rigid boundaries and a target pen area.
                </p>
                <ul class="list-disc pl-4 text-xs space-y-1 mb-2">
                  <li><strong>Agents:</strong> 100 Sheep, 1 Autonomous Dog.</li>
                  <li><strong>Logic:</strong> Extended Reynolds' Boids (Separation, Alignment, Cohesion) + Escape behavior.</li>
                  <li><strong>Variables:</strong> Cohesion parameters were adjusted to simulate Merino (high cohesion) and Black Headed (low cohesion) breeds.</li>
                </ul>
                <p class="text-xs leading-relaxed">
                  <strong>Protocol:</strong> 10 simulation runs were conducted for each breed to ensure statistical relevance.
                </p>
              </div>
            </div>

            <div class="section-box collapsed" id="card-results">
              <div class="card-header border-b mb-2" onclick="toggleCard('card-results')">
                <h2 class="text-xl font-bold text-slate-800">Results</h2>
                <span class="chevron">â–¼</span>
              </div>
              <div class="card-content">
                <p class="text-xs leading-relaxed mb-2 font-bold text-slate-600">
                  Mean steps to pen (n=10):
                </p>
                
                <div class="grid grid-cols-2 gap-2 mb-3 text-[11px]">
                  <div class="bg-slate-100 p-2 rounded border border-slate-200">
                    <span class="block text-[9px] uppercase tracking-wide text-slate-500">Merino</span>
                    <span class="font-bold text-[#1E4A39] text-lg">3,996</span>
                    <span class="text-[9px] text-slate-400">avg steps</span>
                  </div>
                  <div class="bg-slate-100 p-2 rounded border border-slate-200">
                    <span class="block text-[9px] uppercase tracking-wide text-slate-500">Black Headed</span>
                    <span class="font-bold text-red-700 text-lg">7,013</span>
                    <span class="text-[9px] text-slate-400">avg steps</span>
                  </div>
                </div>

                <p class="text-xs leading-relaxed text-justify">
                  The data reveals a stark contrast in manageability. The loose-flocking <strong>Black Headed</strong> sheep required approximately <strong>75.5% more time</strong> to herd than the cohesive Merino breed. The standard deviation for Black Headed sheep was also significantly higher, indicating unpredictable herding events.
                </p>
              </div>
            </div>

            <div class="section-box collapsed" id="card-discuss">
              <div class="card-header border-b mb-2" onclick="toggleCard('card-discuss')">
                <h2 class="text-xl font-bold text-slate-800">Discussion</h2>
                <span class="chevron">â–¼</span>
              </div>
              <div class="card-content">
                <p class="text-xs leading-relaxed mb-2">
                  <strong>Interpretation:</strong> High cohesion (Merino) allows the dog to treat the flock as a single "super-agent," minimizing the need for corrective movements. Low cohesion (Black Headed) results in "splintering," forcing the dog to constantly chase stragglers.
                </p>
                <p class="text-xs leading-relaxed">
                  <strong>Implication:</strong> Robotic herding algorithms must be adaptive. A "one-size-fits-all" algorithm that works for Merino sheep may fail or cause exhaustion when applied to looser breeds.
                </p>
              </div>
            </div>
          </div>

          <div class="mt-auto p-4 bg-slate-50 border border-slate-200 rounded text-[10px] text-slate-400 text-center">
            Presented as part of the seminar: <br />
            "Spatial Thinking", with topic "Spatial Simulation"
          </div>
        </aside>
      </main>

      <footer
        class="bg-white border-t-4 border-[#1E4A39] p-2 grid grid-cols-12 items-center gap-4 text-[10px] uppercase tracking-widest text-slate-600 font-mono"
      >
        <div class="col-span-2 flex justify-start">
             <img src="./images/PLUS_logo.jpg" alt="Paris Lodron University Logo" class="h-12 object-contain">
        </div>

        <div class="col-span-8 text-center">
            <p class="font-bold text-slate-400 mb-1">Bilegjargal Bold, Gedeon Igelspacher, Timothy Simons</p>
            <p class="opacity-70 normal-case tracking-normal">
              This research is co-funded by the European Union to engage in the Copernicus Master in Digital Earth, an Erasmus Mundus Joint Master (EMJM), project reference: 101128006, 2023-2029.
            </p>
        </div>

        <div class="col-span-2 flex justify-end">
             <img src="./images/eu_cofunded_logo.jpg" alt="CO-funded by the european union logo" class="h-8 object-contain">
        </div>
      </footer>
    </div>

    <script type="module">
      import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";;

      // --- Layout Switching Logic ---
      const simDiv = document.getElementById("simulation-container");
      const vidDiv = document.getElementById("video-container");
      const gameVidDiv = document.getElementById("game-video-container");
      
      const bSim = document.getElementById("btn-sim");
      const bGameVid = document.getElementById("btn-game-vid");
      const bRes = document.getElementById("btn-res");
      

      const resVideoPlayer = document.getElementById("resVideo");
      const gameVideoPlayer = document.getElementById("gameVideo");

      const vidMerino = document.getElementById("video-merino");
      const vidScottish = document.getElementById("video-scottish");
      const btnVidMerino = document.getElementById("btn-vid-merino");
      const btnVidScottish = document.getElementById("btn-vid-scottish");
      let currentGamaVideo = vidMerino; // Track which one is active

      // NEW: Get the sidebar containers
      const sidebarGame = document.getElementById("sidebar-game");
      const sidebarImrad = document.getElementById("sidebar-real");
      const sidebarReal = document.getElementById("sidebar-imrad");

      function hideAll() {
        simDiv.style.display = "none";
        vidDiv.style.display = "none";
        gameVidDiv.style.display = "none";
        bSim.classList.remove("active");
        bGameVid.classList.remove("active");
        bRes.classList.remove("active");
        resVideoPlayer.pause();
        // Pause BOTH Gama videos
        vidMerino.pause();
        vidScottish.pause();
      }

      function showSidebar(sidebar) {
        // Hide all sidebars
        sidebarGame.classList.add("hidden");
        sidebarGame.classList.remove("flex");
        sidebarImrad.classList.add("hidden");
        sidebarImrad.classList.remove("flex");
        sidebarReal.classList.add("hidden");
        sidebarReal.classList.remove("flex");
        
        // Show the selected sidebar
        sidebar.classList.remove("hidden");
        sidebar.classList.add("flex");
      }

      bSim.onclick = () => {
        hideAll();
        simDiv.style.display = "block";
        bSim.classList.add("active");
        showSidebar(sidebarGame);
      };

      bGameVid.onclick = () => {
        hideAll();
        gameVidDiv.style.display = "block";
        bGameVid.classList.add("active");
        // Play only the active one
        currentGamaVideo.play();
        showSidebar(sidebarReal);
      };

      bRes.onclick = () => {
        hideAll();
        vidDiv.style.display = "block";
        bRes.classList.add("active");
        resVideoPlayer.play();
        showSidebar(sidebarImrad);
      };

      // --- Gama Video Toggle Logic ---
      btnVidMerino.onclick = () => {
        // Update Buttons
        btnVidMerino.className = "px-4 py-1.5 rounded-full text-[10px] uppercase tracking-wider font-bold bg-[#1E4A39] text-white shadow-sm transition-all";
        btnVidScottish.className = "px-4 py-1.5 rounded-full text-[10px] uppercase tracking-wider font-bold text-slate-600 hover:bg-slate-100 transition-all";
        
        // Switch Videos
        vidScottish.classList.add("hidden");
        vidScottish.pause();
        
        vidMerino.classList.remove("hidden");
        vidMerino.play();
        
        currentGamaVideo = vidMerino;
      };

      btnVidScottish.onclick = () => {
        // Update Buttons
        btnVidScottish.className = "px-4 py-1.5 rounded-full text-[10px] uppercase tracking-wider font-bold bg-[#1E4A39] text-white shadow-sm transition-all";
        btnVidMerino.className = "px-4 py-1.5 rounded-full text-[10px] uppercase tracking-wider font-bold text-slate-600 hover:bg-slate-100 transition-all";
        
        // Switch Videos
        vidMerino.classList.add("hidden");
        vidMerino.pause();
        
        vidScottish.classList.remove("hidden");
        vidScottish.play();
        
        currentGamaVideo = vidScottish;
      };

      window.toggleCard = (id) => {
        const targetCard = document.getElementById(id);
        const isAlreadyCollapsed = targetCard.classList.contains("collapsed");
        document.querySelectorAll(".section-box").forEach((card) => {
          card.classList.add("collapsed");
        });
        if (isAlreadyCollapsed) {
          targetCard.classList.remove("collapsed");
        }
      };

      window.toggleHudParams = () => {
        const content = document.getElementById('hud-params-content');
        const icon = document.getElementById('hud-chevron');
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            icon.classList.remove('collapsed-icon');
        } else {
            content.classList.add('collapsed');
            icon.classList.add('collapsed-icon');
        }
      };

      // --- CHART & STATS LOGIC ---
      const breedStats = {
          merino: { runs: 0, totalTime: 0, totalScore: 0, totalPossible: 0 },
          scottish: { runs: 0, totalTime: 0, totalScore: 0, totalPossible: 0 }
      };
      let chartInstance = null;
      let hasData = false; // Flag to track if we have stats to show

      // DOM Elements for Stats
      const statsBtn = document.getElementById('stats-btn');
      const statsModal = document.getElementById('stats-modal');
      const closeStatsBtn = document.getElementById('close-stats');

      // Toggle Logic
      statsBtn.onclick = () => {
          statsModal.classList.remove('hidden');
          if(!chartInstance) {
              initChart();
          } else {
              chartInstance.update();
          }
      };

      closeStatsBtn.onclick = () => {
          statsModal.classList.add('hidden');
      };

      function initChart() {
          const m = breedStats.merino;
          const s = breedStats.scottish;
          
          const mTime = m.runs ? m.totalTime / m.runs : 0;
          const mSucc = m.runs ? (m.totalScore / m.totalPossible) * 100 : 0;
          
          const sTime = s.runs ? s.totalTime / s.runs : 0;
          const sSucc = s.runs ? (s.totalScore / s.totalPossible) * 100 : 0;

          const ctx = document.getElementById('herdingChart').getContext('2d');
          chartInstance = new Chart(ctx, {
            type: 'bar', // Sets both datasets to Bar type
            data: {
              labels: ['Merino', 'Scottish'],
              datasets: [
                {
                  label: 'Time (s)',
                  data: [mTime, sTime],
                  backgroundColor: '#1E4A39', // Dark Green
                  yAxisID: 'y',
                  barPercentage: 0.8,
                  categoryPercentage: 0.8
                },
                {
                  label: 'Success %',
                  data: [mSucc, sSucc],
                  backgroundColor: '#2d7a5a', // Lighter Green (Different color)
                  yAxisID: 'y1',
                  barPercentage: 0.8,
                  categoryPercentage: 0.8
                }
              ]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  beginAtZero: true,
                  title: { display: true, text: 'Seconds' }
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  min: 0,
                  max: 100,
                  grid: { drawOnChartArea: false }, // Hides grid lines for the right axis
                  title: { display: true, text: 'Success %' }
                }
              }
            }
          });
      }

      function updateStats(breed, time, caught, total) {
          if (!breedStats[breed]) return; 
          
          const s = breedStats[breed];
          s.runs++;
          s.totalTime += time;
          s.totalScore += caught;
          s.totalPossible += total;

          // Mark that we have data to show
          hasData = true;

          // If chart is open/created, update data immediately
          if (chartInstance) {
              const m = breedStats.merino;
              const sc = breedStats.scottish;

              const mTime = m.runs ? m.totalTime / m.runs : 0;
              const mSucc = m.runs ? (m.totalScore / m.totalPossible) * 100 : 0;
              const sTime = sc.runs ? sc.totalTime / sc.runs : 0;
              const sSucc = sc.runs ? (sc.totalScore / sc.totalPossible) * 100 : 0;

              chartInstance.data.datasets[0].data = [mTime, sTime];
              chartInstance.data.datasets[1].data = [mSucc, sSucc];
              chartInstance.update();
          }
      }

      // --- SIMULATION PARAMETERS ---
      let SHEEP_COUNT = 30;
      let FENCE_ENABLED = false;
      let currentBreed = 'merino';
      
      const params = {
        sep: 0.001,
        ali: 0.008,
        coh: 0.012,
        fear: 4.0,
        flightDist: 6.0,
        maxSpeed: 0.12,
        panicSpeedMultiplier: 2.2,
      };

      const configs = {
        merino: { sep: 0.001, ali: 0.008, coh: 0.012 },
        scottish: { sep: 0.005, ali: 0.003, coh: 0.004 }
      };

      const breedColors = {
          merino: { body: 0xffffff, head: 0xffffee },
          scottish: { body: 0xf0f0f0, head: 0x111111 },
          custom: { body: 0xffffff, head: 0x808080 }
      };

      let scene, camera, renderer, raycaster;
      let mouse = new THREE.Vector2();
      let groundPlane, dogMesh;
      let sheepArray = [];
      let outerFenceGroup;
      let fenceTargetY = -5;
      
      let score = 0;
      let lostCount = 0;
      let gameActive = false;
      let startTime = null;
      let timerFinished = false;

      let viewBounds = { x: 30, z: 22 }; 
      let fencePadding = 2.5;

      const timerDisplay = document.getElementById("timer-display");
      const hudBox = document.getElementById("controls-box");
      const instructions = document.getElementById("instructions-overlay");
      const countdownEl = document.getElementById("countdown-overlay");
      const scoreEl = document.getElementById("score");
      const lostEl = document.getElementById("lost");
      
      const penBounds = { xMin: 12, xMax: 20, zMin: -8, zMax: 8 };
      const gateLocation = new THREE.Vector3(12, 0, 0);

      function init() {
        const container = document.getElementById("simulation-container");
        const width = container.clientWidth;
        const height = container.clientHeight;

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xdceebb);

        const aspect = width / height;
        const d = 22;
        camera = new THREE.OrthographicCamera(
          -d * aspect,
          d * aspect,
          d,
          -d,
          1,
          1000,
        );
        camera.position.set(20, 20, 20);
        camera.lookAt(0, 0, 0);
        
        viewBounds.x = d * aspect;
        viewBounds.z = d;

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const sun = new THREE.DirectionalLight(0xffffff, 0.8);
        sun.position.set(15, 30, 10);
        sun.castShadow = true;
        sun.shadow.mapSize.set(2048, 2048);
        scene.add(sun);

        groundPlane = new THREE.Mesh(
          new THREE.PlaneGeometry(100, 100),
          new THREE.MeshStandardMaterial({ color: 0x567d46 }),
        );
        groundPlane.rotation.x = -Math.PI / 2;
        groundPlane.receiveShadow = true;
        scene.add(groundPlane);

        createPen();
        createOuterFence();
        createDog();
        setupUI();
        
        // Don't initChart() here anymore. We wait until user clicks button.
        resetSim(false);

        raycaster = new THREE.Raycaster();
        window.addEventListener("resize", onResize);
        container.addEventListener("mousemove", onMouseMove);

        animate();
      }

      function createOuterFence() {
          if (outerFenceGroup) scene.remove(outerFenceGroup);
          outerFenceGroup = new THREE.Group();

          const woodMat = new THREE.MeshStandardMaterial({ color: 0x5a3825 });
          const thickness = 0.4;
          const height = 1.2;
          
          const boundsX = viewBounds.x - fencePadding;
          const boundsZ = viewBounds.z - fencePadding;
          const w = boundsX * 2;
          const d = boundsZ * 2;
          
          const top = new THREE.Mesh(new THREE.BoxGeometry(w, height, thickness), woodMat);
          top.position.set(0, height/2, -boundsZ);
          outerFenceGroup.add(top);

          const bot = new THREE.Mesh(new THREE.BoxGeometry(w, height, thickness), woodMat);
          bot.position.set(0, height/2, boundsZ);
          outerFenceGroup.add(bot);

          const left = new THREE.Mesh(new THREE.BoxGeometry(thickness, height, d), woodMat);
          left.position.set(-boundsX, height/2, 0);
          outerFenceGroup.add(left);

          const right = new THREE.Mesh(new THREE.BoxGeometry(thickness, height, d), woodMat);
          right.position.set(boundsX, height/2, 0);
          outerFenceGroup.add(right);

          outerFenceGroup.position.y = -5;
          scene.add(outerFenceGroup);
      }

      function setupUI() {
        document.getElementById("param-count").addEventListener("input", (e) => {
            SHEEP_COUNT = parseInt(e.target.value);
            document.getElementById("val-count").innerText = SHEEP_COUNT;
            if(!gameActive) resetSim(false);
        });

        document.getElementById("param-fence").addEventListener("change", (e) => {
            FENCE_ENABLED = e.target.checked;
            fenceTargetY = FENCE_ENABLED ? 0 : -5;
        });

        const bind = (id, key) => {
          document.getElementById(id).addEventListener("input", (e) => {
            params[key] = parseFloat(e.target.value);
            document.getElementById("val-" + key).innerText = params[key].toFixed(4);
            const customRadio = document.querySelector('input[name="breed"][value="custom"]');
            if (customRadio) {
                customRadio.checked = true;
                currentBreed = 'custom';
                updateSheepColors();
            }
          });
        };
        bind("param-sep", "sep");
        bind("param-ali", "ali");
        bind("param-coh", "coh");

        document.querySelectorAll('input[name="breed"]').forEach(radio => {
          radio.addEventListener('change', (e) => {
            currentBreed = e.target.value;
            const config = configs[currentBreed];
            const colors = breedColors[currentBreed];

            if (config) {
              params.sep = config.sep;
              params.ali = config.ali;
              params.coh = config.coh;
              document.getElementById("param-sep").value = config.sep;
              document.getElementById("param-ali").value = config.ali;
              document.getElementById("param-coh").value = config.coh;
              document.getElementById("val-sep").innerText = config.sep.toFixed(4);
              document.getElementById("val-ali").innerText = config.ali.toFixed(4);
              document.getElementById("val-coh").innerText = config.coh.toFixed(4);
            }

            updateSheepColors();
          });
        });

        document.getElementById("reset-sim").addEventListener("click", () => {
          resetSim(false);
          hudBox.classList.remove("hidden-hud");
          instructions.style.opacity = "1";
        });

        document.getElementById("start-sim").addEventListener("click", () => {
          resetSim(false);
          triggerGameStart();
        });
      }

      function updateSheepColors() {
          const colors = breedColors[currentBreed];
          if (colors) {
              sheepArray.forEach(s => {
                  if (!s.isCaught) {
                      s.body.material.color.set(colors.body);
                      s.head.material.color.set(colors.head);
                  }
              });
          }
      }

      function triggerGameStart() {
        hudBox.classList.add("hidden-hud");
        instructions.style.opacity = "0";
        // Hide Stats Button while playing
        statsBtn.style.display = 'none';
        statsModal.classList.add('hidden');

        let count = 3;
        countdownEl.style.opacity = "1";
        countdownEl.innerText = count;

        const interval = setInterval(() => {
          count--;
          if (count > 0) {
            countdownEl.innerText = count;
          } else if (count === 0) {
            countdownEl.innerText = "GO!";
          } else {
            clearInterval(interval);
            countdownEl.style.opacity = "0";
            startGameLogic();
          }
        }, 800);
      }

      function startGameLogic() {
        gameActive = true;
        startTime = Date.now();
        document.getElementById("simulation-container").style.cursor = "none"; // Hide cursor
      }

      function createPen() {
        const woodMat = new THREE.MeshStandardMaterial({ color: 0x5a3825 });
        const postGeo = new THREE.BoxGeometry(0.4, 1.5, 0.4);
        const fencePos = [];
        for (let z = penBounds.zMin; z <= penBounds.zMax; z += 2)
          fencePos.push({ x: penBounds.xMax, z });
        for (let x = penBounds.xMin; x <= penBounds.xMax; x += 2) {
          fencePos.push({ x, z: penBounds.zMin });
          fencePos.push({ x, z: penBounds.zMax });
        }
        fencePos.forEach((p) => {
          const post = new THREE.Mesh(postGeo, woodMat);
          post.position.set(p.x, 0.75, p.z);
          post.castShadow = true;
          scene.add(post);
        });
      }

      function createDog() {
        const dogGroup = new THREE.Group();
        const body = new THREE.Mesh(
          new THREE.BoxGeometry(0.7, 0.5, 1.2),
          new THREE.MeshStandardMaterial({ color: 0x1a1a1a }),
        );
        body.position.y = 0.35;
        body.castShadow = true;
        dogGroup.add(body);
        const head = new THREE.Mesh(
          new THREE.BoxGeometry(0.4, 0.4, 0.5),
          new THREE.MeshStandardMaterial({ color: 0x6e370f }),
        );
        head.position.set(0, 0.7, 0.4);
        dogGroup.add(head);
        dogMesh = dogGroup;
        scene.add(dogMesh);
      }

      function createSheep() {
        const group = new THREE.Group();
        const colors = breedColors[currentBreed] || breedColors.merino;

        const bodyMat = new THREE.MeshStandardMaterial({ color: colors.body });
        const body = new THREE.Mesh(new THREE.SphereGeometry(0.5, 12, 12), bodyMat);
        body.position.y = 0.5;
        body.castShadow = true;
        group.add(body);

        const headMat = new THREE.MeshStandardMaterial({ color: colors.head });
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 0.4), headMat);
        head.position.set(0, 0.7, 0.4);
        group.add(head);
        
        group.position.x = (Math.random() - 0.5) * 15 - 5;
        group.position.z = (Math.random() - 0.5) * 20;
        scene.add(group);
        
        sheepArray.push({
          mesh: group,
          velocity: new THREE.Vector3(
            (Math.random() - 0.5) * 0.1,
            0,
            (Math.random() - 0.5) * 0.1,
          ),
          isCaught: false,
          isLost: false,
          body: body, 
          head: head
        });
      }

      function resetSim(active = true) {
        sheepArray.forEach((s) => scene.remove(s.mesh));
        sheepArray = [];
        score = 0;
        lostCount = 0;
        timerFinished = false;
        gameActive = false;
        startTime = null;
        
        // Show cursor
        document.getElementById("simulation-container").style.cursor = "default"; 

        // Only show button if we actually have data from a previous run
        statsBtn.style.display = hasData ? 'flex' : 'none';

        scoreEl.innerText = "0";
        lostEl.innerText = "0";
        document.getElementById("total").innerText = SHEEP_COUNT;
        timerDisplay.innerText = "00:00.0";
        
        for (let i = 0; i < SHEEP_COUNT; i++) createSheep();
      }

      function onMouseMove(e) {
        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
      }

      function onResize() {
        const container = document.getElementById("simulation-container");
        const w = container.clientWidth;
        const h = container.clientHeight;
        camera.aspect = w / h;
        const d = 22;
        camera.left = -d * camera.aspect;
        camera.right = d * camera.aspect;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
        
        viewBounds.x = d * camera.aspect;
        viewBounds.z = d;
        
        createOuterFence(); 
      }

      function animate() {
        requestAnimationFrame(animate);

        if (outerFenceGroup) {
            outerFenceGroup.position.y += (fenceTargetY - outerFenceGroup.position.y) * 0.1;
        }

        if (gameActive && !timerFinished && startTime) {
          const elapsed = Date.now() - startTime;
          const seconds = Math.floor(elapsed / 1000);
          const ms = Math.floor((elapsed % 1000) / 100);
          const m = Math.floor(seconds / 60);
          const s = seconds % 60;
          timerDisplay.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}.${ms}`;
        }

        raycaster.setFromCamera(mouse, camera);
        const hit = raycaster.intersectObject(groundPlane);
        
        const fbX = viewBounds.x - fencePadding;
        const fbZ = viewBounds.z - fencePadding;

        if (gameActive && hit.length > 0) {
          let target = hit[0].point;
          if (FENCE_ENABLED) {
              const dogPad = 0.8; 
              target.x = Math.max(-fbX + dogPad, Math.min(fbX - dogPad, target.x));
              target.z = Math.max(-fbZ + dogPad, Math.min(fbZ - dogPad, target.z));
          }
          const prevPos = dogMesh.position.clone();
          dogMesh.position.lerp(target, 0.2);
          dogMesh.position.y = 0;
          const movement = new THREE.Vector3().subVectors(
            dogMesh.position,
            prevPos,
          );
          if (movement.length() > 0.01)
            dogMesh.rotation.y = Math.atan2(movement.x, movement.z);
        }

        let caughtCount = 0;
        let currentLostCount = 0;

        sheepArray.forEach((s) => {
          if (s.isCaught) {
            caughtCount++;
            s.velocity.multiplyScalar(0.9);
            s.mesh.position.add(s.velocity);
            return;
          }
          if (s.isLost) {
            currentLostCount++;
            return;
          }

          if (!gameActive) return;

          if (FENCE_ENABLED) {
            const sheepPad = 0.5;
            if (s.mesh.position.x > fbX - sheepPad) { s.mesh.position.x = fbX - sheepPad; s.velocity.x *= -1; }
            if (s.mesh.position.x < -fbX + sheepPad) { s.mesh.position.x = -fbX + sheepPad; s.velocity.x *= -1; }
            if (s.mesh.position.z > fbZ - sheepPad) { s.mesh.position.z = fbZ - sheepPad; s.velocity.z *= -1; }
            if (s.mesh.position.z < -fbZ + sheepPad) { s.mesh.position.z = -fbZ + sheepPad; s.velocity.z *= -1; }
          } else {
            const buffer = 5; 
            if (
                Math.abs(s.mesh.position.x) > fbX + buffer || 
                Math.abs(s.mesh.position.z) > fbZ + buffer
            ) {
                s.isLost = true;
                scene.remove(s.mesh);
                return;
            }
          }

          if (
            s.mesh.position.x > penBounds.xMin + 0.5 &&
            s.mesh.position.x < penBounds.xMax &&
            s.mesh.position.z > penBounds.zMin &&
            s.mesh.position.z < penBounds.zMax
          ) {
            s.isCaught = true;
            s.body.material.color.set(0x44bb44);
            s.head.material.color.set(0x44bb44);
          }

          let vSep = new THREE.Vector3(),
            vAli = new THREE.Vector3(),
            vCoh = new THREE.Vector3(),
            vFear = new THREE.Vector3(),
            neighbors = 0,
            center = new THREE.Vector3();

          sheepArray.forEach((other) => {
            if (other === s || other.isCaught || other.isLost) return;
            const d = s.mesh.position.distanceTo(other.mesh.position);
            if (d < 4) {
              vSep.add(
                new THREE.Vector3()
                  .subVectors(s.mesh.position, other.mesh.position)
                  .normalize()
                  .divideScalar(d),
              );
              vAli.add(other.velocity);
              center.add(other.mesh.position);
              neighbors++;
            }
          });

          if (neighbors > 0) {
            vSep.divideScalar(neighbors);
            vAli.divideScalar(neighbors).normalize().multiplyScalar(0.1);
            center.divideScalar(neighbors);
            vCoh
              .subVectors(center, s.mesh.position)
              .normalize()
              .multiplyScalar(0.1);
          }

          const dDog = s.mesh.position.distanceTo(dogMesh.position);
          const isPanicking = dDog < params.flightDist;
          if (isPanicking) {
            vFear.add(
              new THREE.Vector3()
                .subVectors(s.mesh.position, dogMesh.position)
                .normalize()
                .multiplyScalar(
                  params.fear * 0.05 * (params.flightDist / dDog),
                ),
            );
          }

          const dGate = s.mesh.position.distanceTo(gateLocation);
          if (dGate < 8 && !s.isCaught)
            vCoh.add(
              new THREE.Vector3()
                .subVectors(gateLocation, s.mesh.position)
                .normalize()
                .multiplyScalar(0.05),
            );

          s.velocity
            .add(vSep.multiplyScalar(params.sep))
            .add(vAli.multiplyScalar(params.ali))
            .add(vCoh.multiplyScalar(params.coh))
            .add(vFear);
            
          const limit = isPanicking
            ? params.maxSpeed * params.panicSpeedMultiplier
            : params.maxSpeed;
          s.velocity.clampLength(0, limit);
          s.mesh.position.add(s.velocity);
          
          const minGap = 1.0; 
          sheepArray.forEach((other) => {
              if (s === other || other.isCaught || other.isLost) return;
              const d = s.mesh.position.distanceTo(other.mesh.position);
              if (d < minGap) {
                  const push = new THREE.Vector3()
                      .subVectors(s.mesh.position, other.mesh.position)
                      .normalize();
                  const penetration = minGap - d;
                  push.multiplyScalar(penetration * 0.5); 
                  s.mesh.position.add(push);
              }
          });
          const dogRadius = 0.8;
          const sheepRadius = 0.5;
          const dToDog = s.mesh.position.distanceTo(dogMesh.position);
          if (dToDog < dogRadius + sheepRadius) {
             const push = new THREE.Vector3()
                .subVectors(s.mesh.position, dogMesh.position)
                .normalize();
             const penetration = (dogRadius + sheepRadius) - dToDog;
             push.multiplyScalar(penetration); 
             s.mesh.position.add(push);
          }

          if (s.mesh.position.x > penBounds.xMin && !s.isCaught) {
            if (
              s.mesh.position.z < penBounds.zMin ||
              s.mesh.position.z > penBounds.zMax
            ) {
              s.mesh.position.x = penBounds.xMin - 0.1;
              s.velocity.x *= -0.5;
            }
          }
          if (s.velocity.length() > 0.01) {
            const targetDir = s.mesh.position.clone().add(s.velocity);
            s.mesh.lookAt(targetDir.x, 0.5, targetDir.z);
          }
        });

        if (caughtCount !== score) {
          score = caughtCount;
          scoreEl.innerText = score;
        }
        if (currentLostCount !== lostCount) {
          lostCount = currentLostCount;
          lostEl.innerText = lostCount;
        }

        if (gameActive && !timerFinished && (score + lostCount >= SHEEP_COUNT)) {
          timerFinished = true;
          gameActive = false; // Stop the simulation (freezes dog and sheep)
          document.getElementById("simulation-container").style.cursor = "default"; // Show cursor
          hudBox.classList.remove("hidden-hud");
          
          // Show Stats Button when game over
          const elapsed = (Date.now() - startTime) / 1000;
          updateStats(currentBreed, elapsed, score, SHEEP_COUNT);
          statsBtn.style.display = 'flex';
        }

        renderer.render(scene, camera);
      }

      init();
    </script>
  </body>
</html>